#!/bin/bash

#This file is part of the TinyTools distribution (https://github.com/Calebe94/TinyTools).
#Copyright (C)  TinyTools

#This program is free software: you can redistribute it and/or modify
#it under the terms of the GNU General Public License as published by
#the Free Software Foundation, version 3 of the License.

#This program is distributed in the hope that it will be useful,
#but WITHOUT ANY WARRANTY; without even the implied warranty of
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#GNU General Public License for more details.

#You should have received a copy of the GNU General Public License
#along with this program.  If not, see <http://www.gnu.org/licenses/>.

pyprochtml_path=/tmp/pyprocesshtml.py
header_path=/tmp/_header.html
footer_path=/tmp/_footer.html
tmp_folder=/tmp/tmdpress

cat << EOF > $pyprochtml_path
#!/usr/bin/python
import sys 
file_content=str()
for line in sys.stdin: 
    file_content+=line
content_splited = file_content.split('<hr />')
for slide in content_splited:
    print('<div class="slide">')
    print(slide.strip())
    print('</div>')
EOF

cat << EOF > $header_path
<html>
<title>__TITLE__</title>
<body style="margin: 80px;">
EOF

cat << EOF > $footer_path
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
.slide {
  font-family: arial;
  font-size: 40pt;
  font-weight: 1800;
  width: "100%";
}
xmp {
  font-family: monospace;
  font-size: 28pt;
  background-color: LightBlue;
}
@media print {
.slide {
    page-break-before: always;
  }
}
@page { size: landscape; }
</style>
<div class="buttons" style="position:fixed; bottom: 20px;">
  <button onclick="plusDivs(-1)">&#10094;</button>
  <button onclick="plusDivs1)">&#10095;</button>
  <button onclick="printSlides()">print</button>
</div>
<div id="pagenumber" style="position:fixed; bottom: 20px; right: 20px;">1</div>
<script>
var slideIndex = 1;
document.addEventListener("keydown", ki, false);
function ki(e) {
  var keyCode = e.keyCode;
  if(keyCode==39) {
    plusDivs(1);
  }
  if(keyCode==37) {
    plusDivs(-1);
  }
  if(keyCode==80) {
    printSlides();
  }
  if(keyCode==72) {
    hideButtons();
  }
}
showDivs(slideIndex);
function hideButtons() {
  var x = document.getElementsByClassName("buttons");
  if(x[0].style.display == "none") x[0].style.display = "block"
  else x[0].style.display = "none";
}
function plusDivs(n) {
  showDivs(slideIndex += n);
}
function showDivs(n) {
  var i;
  var x = document.getElementsByClassName("slide");
  if (n > x.length) {slideIndex = 1}
  if (n < 1) {slideIndex = x.length}
  for (i = 0; i < x.length; i++) {
     x[i].style.display = "none";
  }
  x[slideIndex - 1].style.display = "block";
  var y = document.getElementById("pagenumber");
  y.innerHTML = slideIndex + "/" + x.length;
}
function printSlides() {
  var i;
  var y = document.getElementById("pagenumber");
  y.innerHTML = "";
  var x = document.getElementsByClassName("slide");
  for (i = 0; i < x.length; i++) {
     x[i].style.display = "none";
  }
  for (i = 0; i < x.length; i++) {
     x[i].style.display = "block";
  }
  window.print();
  for (i = 0; i < x.length; i++) {
     x[i].style.display = "none";
  }
  x[slideIndex - 1].style.display = "block";
}
</script>
EOF

usage()
{
    echo "tmdpress presentation.md"
    exit 1
}

create_tmp_folder()
{
    mkdir -p "$tmp_folder"
}

copy_template_files()
{
    filename="$1"
    header_pres="header_${filename%.*}.html"
    footer_pres="footer_${filename%.*}.html"
    cp _header.html "$tmp_folder/$header_pres"
    cp _footer.html "$tmp_folder/$footer_pres"
}

fill_metadata()
{
    filename="$1"
    header_pres="header_${filename%.*}.html"
    title=$(tyaml $filename -v title)
    header=$(tyaml $filename -v header)
    footer=$(tyaml $filename -v footer)
    content=$(cat $filename)
    sed "s+__TITLE__+$title+g" $header_path > "$tmp_folder/$header_pres"
    #sed "s+__HEADER__+$header+g" "$tmp_folder/$header_pres"
    #sed "s+__FOOTER__+$footer+g" "$tmp_folder/$header_pres"
}

convert_md_to_html()
{
    filename="$1"
    pandoc_filename="pandoc_${filename%.*}".html
    pandoc "$filename" -t html | process_html_file > "$tmp_folder/$pandoc_filename"
}

process_html_file()
{
    python $pyprochtml_path
}

create_presentation()
{
    filename="$1"
    pres_filename="${filename%.*}".html
    pandoc_filename="pandoc_${filename%.*}".html
    header_pres="header_${filename%.*}.html"
    footer_pres="footer_${filename%.*}.html"
    cat $tmp_folder/$header_pres $tmp_folder/$pandoc_filename $footer_path > $pres_filename
}

remove_tmp_folder()
{
    rm -fr "$tmp_folder"
}

[ -z "$1" ] && usage

filename=$1

[ -d $tmp_folder ] &&  rm -fr remove_tmp_folder

create_tmp_folder

#copy_template_files "$filename"
fill_metadata "$filename"
convert_md_to_html "$filename"
create_presentation "$filename"

echo "OK!"
